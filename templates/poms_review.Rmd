---
title: "PoMS Feedback"
params:
    user_name: ""
    user_data: ""
    bg_data: ""
    bg_computed_objects: ""
    user_computed_objects: ""
    user_email: "UNKNOWN"
    content_key: ""
    config: ""
    extra_params: ""
footer-date-time: "`r  format(Sys.time(), '%Y-%m-%d %H:%M:%S %Z')`"
user-email: "`r params$user_email`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      warning = F,
                      message = FALSE, 
                      fig.align = 'center',
                      error=F,
                      results='asis')
```



```{r calculations, include=F}
#here you can do simple calculations for generating metrics that you later include in the text of the email. However if you wish to do more complex calculations it is recommended that these are done via prior (method tbc)



```

```{r packages, include =F}
library(dplyr) #wrangling
library(ggplot2) #plotting
library(htmltools)
library(tidyr)
library(knitr)
library(ggspatial)
library(ggrepel)
```

<p align="center">
![](static/poms/poms_logo.png){width=250px}
</p>

```{r, results='asis'}
include_message <- T
if(include_message){
  cat("<div style='border: 2px grey; padding: 10px; background-color: lightgrey;'><p>We are trialling personalised insights for UK PoMS. This will include summaries and data visualisations based on the PoMS FIT Counts you have contributed. You are receiving this email because you have submitted at least one PoMS FIT Count in 2025 or 2024.</p><p>This email is the first of these insights. They will be sent infrequently, and we intend to send one more email in 2025 towards the end of the PoMS monitoring seasons.</p><p>If you do not wish to receive these emails you can opt-out <a href='",paste0("https://forms.cloud.microsoft/Pages/ResponsePage.aspx?id=NlECf_M5LE-jxsuxziGzal97bLz2Q2BBrnNyNFwVq4NUMVRRTVkyMlo4STNMQkIyOVRKT1BUS0xDRi4u&r98c2e00a38e74d83bbf09f9077ce42c8=",params$user_email),"'>here</a></p></div>")
}

```

```{r}
current_year <- lubridate::year(Sys.Date())
previous_year <- current_year -1

recorded_this_year <- (params$user_data %>% filter(as.POSIXct(date_from)>as.Date("2025-01-01")) %>% nrow())>0
focal_year <- if_else(recorded_this_year,current_year,previous_year)
```

# Your PoMS FIT Count Update

Hello `r params$user_name`,

Welcome to your personal PoMS FIT Count update. Let's see what data you've contributed! If you need any information about how to do a FIT Count please visit the [PoMS website](https://ukpoms.org.uk/fit-counts). 

`r if_else(recorded_this_year,"","You haven't submitted any FIT Counts for 2025 yet. Let's take a look at your counts for 2024.")`

```{r}
#SUMMARY
if(recorded_this_year){
  message1 <- paste0("You counted ",params$user_computed_objects$mean_n_insects," insects in ",current_year, " across **", params$user_computed_objects$mean_n_fit_counts,"** FIT Counts.")
} else {
    message1 <- paste0("You counted ",params$user_computed_objects$mean_n_insects_prev," insects in ",previous_year, " across **", params$user_computed_objects$mean_n_fit_counts_prev,"** FIT Counts.")
}
```

## Summary

`r message1`

## Your latest FIT Count

```{r}
last_count <- params$user_data %>% arrange(as.POSIXct(desc(date_from))) %>% head(1)

last_count2 <- last_count %>%
    pivot_longer(c(bumblebees,honeybees,solitary_bees,wasps,hoverflies,other_flies,butterflies_moths,beetles,insects_small,insects_other),names_to = "group",values_to = "count") %>%
  mutate(image = paste0("templates/static/poms/",group,".png"),
         group = recode(group, 
                      bumblebees = "Bumblebees",
                      honeybees = "Honeybees",
                      solitary_bees = "Solitary Bees",
                      wasps = "Wasps",
                      hoverflies = "Hoverflies",
                      other_flies = "Other Flies",
                      butterflies_moths = "Butterflies and Moths",
                      beetles = "Beetles",
                      insects_small = "Small Insects",
                      insects_other = "Other Insects")) %>%
  mutate(group = factor(group,
                      levels = rev(c("Bumblebees", "Honeybees", "Solitary Bees", "Wasps", 
                                 "Hoverflies", "Other Flies", "Butterflies and Moths",
                                 "Beetles", "Small Insects", "Other Insects"))))

```

The last FIT Count you did was **`r as.numeric(difftime(Sys.Date(),last_count$date_from %>% as.Date(),units= "days"))`** days ago on `r last_count$date_from %>% as.Date() %>% format("%A %d %B %Y")`, you observed **`r sum(last_count2$count, na.rm=T)`** insects and the target flower was `r tolower(last_count$target_flower) %>% substr(., 1, nchar(.)-1)`. `r if_else(sum(last_count2$count, na.rm=T)==0,"Even though you recorded no insects your FIT Count still provides us with valuable data about pollinating insects!","") `

```{r}
if(sum(last_count2$count, na.rm=T)>0){
  last_count2 %>% ggplot(aes(y= group, x= count))+
  geom_col(fill = "#b31982")+
  theme_minimal(base_size = 15) +
  labs(y = "Pollinator group",x = "Number of insects")+
  scale_x_continuous(breaks = function(x) unique(floor(pretty(seq(min(x), (max(x) + 1) * 1.1))))) # only integer values
}

# if(sum(last_count2$count, na.rm=T)>0){
#   
#   last_count2 %>% 
#     mutate(count = if_else(is.na(count),0,count)) %>%
#     uncount(weights = count) %>%
#     group_by(group) %>%
#     mutate(y = row_number()) %>%
#       ggplot(aes(y= y, x= group))+
#       geom_point(fill = "#b31982")+
#       theme_minimal(base_size = 15) +
#       labs(y = "Pollinator group",x = "Number of insects")+
#       theme(axis.title.y=element_blank(),
#         axis.text.y=element_blank(),
#         axis.ticks.y=element_blank())
#   
# }
```

## Count activity

```{r}
if(recorded_this_year){
  message2 <- paste0("So far in ",current_year," you have contributed **",params$user_computed_objects$mean_n_fit_counts,"** FIT Counts - thank you. Every single count helps make our data more meaningful! If you were able to take part in 2024, your counts from 2024 are represented in grey.")
} else {
    message2 <- paste0("In ",previous_year," you contributed **",params$user_computed_objects$mean_n_fit_counts_prev,"** FIT Counts. Every single count helps make our data more meaningful!")
}

```

`r message2`

```{r}
library(lubridate)
first_point <- data.frame(cumulative = 0,day = lubridate::floor_date(as.POSIXct(paste0(previous_year,"-01-01")), "day"))
last_point <- params$user_computed_objects$daily_counts_previous_year %>%
  mutate(cumulative = cumsum(n)) %>% tail(1)

if(length(last_point$cumulative)==0){
  last_point_prev_year <- data.frame(cumulative = 0, day = as.POSIXct(paste0(current_year,"-12-31")))
} else {
  last_point_prev_year <- data.frame(cumulative = last_point$cumulative, day = as.POSIXct(paste0(current_year,"-12-31")))
}


previous_year_df <- params$user_computed_objects$daily_counts_previous_year %>%
  mutate(cumulative = cumsum(n)) %>%
  bind_rows(first_point) %>%
  bind_rows(last_point_prev_year) %>%
  mutate(day = day %m+% years(1))

first_point <- data.frame(cumulative = 0,day = lubridate::floor_date(as.POSIXct(paste0(current_year,"-01-01")), "day"))
last_point <- params$user_computed_objects$daily_counts_current_year %>%
  mutate(cumulative = cumsum(n)) %>% tail(1)



current_year_df <- params$user_computed_objects$daily_counts_current_year %>%
  mutate(cumulative = cumsum(n)) %>%
  bind_rows(first_point)

#add an october point if drawing previous year only
if(!recorded_this_year){
  current_year_df <- current_year_df %>% bind_rows(last_point_prev_year)
}

date_lims <- as.POSIXct(c(paste0(current_year,"-03-29"),paste0(current_year,"-10-01")))
current_year_df %>%
  ggplot(aes(x = day, y= cumulative)) +
  {if(recorded_this_year)geom_step(data = previous_year_df,size = 1,colour = "grey")}+
  {if(recorded_this_year)geom_step(size = 1,colour = "#b31982")} +
  {if(recorded_this_year)geom_point(data = last_point,size = 4,shape = 17,colour = "#b31982")} +
  {if(!recorded_this_year)geom_step(data = previous_year_df,size = 1,colour = "#b31982")}+
  scale_x_datetime(date_breaks="1 month", date_labels="%b") +
  scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(min(x), (max(x) + 1) * 1.1)))))+
  theme_minimal(base_size = 15)+
  labs(x = "Date",y = "Cumulative number of FIT Counts")+
  coord_cartesian(xlim=date_lims)+
  {if(recorded_this_year)geom_label_repel(data = last_point,label = current_year,colour = "#b31982",nudge_x = -1000000,min.segment.length=1000)}+
  {if(recorded_this_year)geom_label_repel(data = last_point_prev_year,label = previous_year,colour = "grey",min.segment.length=1000)}+
  {if(!recorded_this_year)geom_label_repel(data = last_point_prev_year,label = previous_year,colour = "#b31982",nudge_x = -1000000,min.segment.length=1000)}

```

```{r}

if(recorded_this_year){
  plot_data <- params$bg_computed_objects$daily_counts_current_year %>%
    mutate(type = "others") %>%
    bind_rows(mutate(params$user_computed_objects$daily_counts_current_year,type = "you")) %>%
    filter(day >= as.Date(paste0(current_year,"-03-29")),
           day < as.Date(paste0(current_year,"-10-01")))
  
  message3 <- paste0(
    "Altogether, a total of **",
    params$bg_computed_objects$daily_counts_current_year$n %>% sum(),
    "** FIT Counts have been submitted to UK PoMS so far in ",
    current_year,
    ". Highest number of FIT Counts on a single day was ",
    params$bg_computed_objects$daily_counts_current_year$n %>% max(),
    "! The plot below shows your FIT Count activity plotted against all counts submitted across the UK."
  )
  
} else {
    plot_data <- params$bg_computed_objects$daily_counts_previous_year %>%
    mutate(type = "others") %>%
    bind_rows(mutate(params$user_computed_objects$daily_counts_previous_year,type = "you")) %>%
    filter(day >= as.Date(paste0(previous_year,"-03-29")),
           day < as.Date(paste0(previous_year,"-10-01")))
    
  message3 <- paste0(
    "Altogether, a total of **",
    params$bg_computed_objects$daily_counts_previous_year$n %>% sum(),
    "** FIT Counts were submitted to UK PoMS in ",
    previous_year,
    ". Highest number of FIT Counts on a single day was ",
    params$bg_computed_objects$daily_counts_previous_year$n %>% max(),
    "! The plot below shows your FIT Count activity plotted against all counts submitted across the UK."
  )
}
```

`r message3`

```{r}

plot_data %>%
  ggplot(aes(x = day,y = n,fill = type)) + 
    geom_col(width = 86400,position="identity")+
    scale_fill_manual(labels = c("Other FIT Counters","Your contributions"),values=c("grey","#b31982"))+
    scale_x_datetime(date_breaks="1 month", date_labels="%b") +
    theme_minimal(base_size = 15) +
    labs(x = "Date",y = "Number of FIT Counts per day")+
    facet_grid(type~.,scales = "free_y") +
    theme(legend.position="top",legend.title = element_blank(),strip.background = element_blank(),
  strip.text.x = element_blank(),
  strip.text.y = element_blank())+
  scale_y_continuous(breaks = function(x) unique(floor(pretty(seq(min(x), (max(x) + 1) * 1.1)))))
  
```


```{r}
if(recorded_this_year){
  message_map <- paste0(
    "Here's a map of the locations of your ",params$user_computed_objects$mean_n_fit_counts," FIT Counts in 2025. If you were able to participate in ",
    previous_year,
    " those locations appear in grey. By carrying out several Counts at one location throughout the year you will be adding extra value to your survey records. You can see where FIT Counts have been done in the current season in the ",
    "[online map](https://ukpoms.org.uk/fit-counts-map)."
  )
} else {
  message_map <- paste0(
    "Here's a map of the locations of your ",params$user_computed_objects$mean_n_fit_counts_prev," FIT Counts from ",
    previous_year,
    ". By carrying out several Counts at one location throughout the year you will be adding extra value to your survey records. You can see where FIT Counts have been done in the current season in the ",
    "[online map](https://ukpoms.org.uk/fit-counts-map)."
    )
  
}


```

`r message_map`

```{r map}
#test <- read.csv(config$data_file)

library(BRCmap)
library(lubridate)

counts_map_data <- params$user_data %>% 
  mutate(year = lubridate::year(as.POSIXct(date_from))) %>%
  group_by(
    year,
    output_spatial_ref
    ) %>%
  summarise(n = n()) %>%
  mutate(label = if_else(n>1,paste0(n," FIT Counts"),paste0(n," FIT Count")))
  
lat_lon <- gr2gps_latlon(counts_map_data$output_spatial_ref)
counts_map_data <- cbind(counts_map_data,lat_lon)
user_data_sf <- sf::st_as_sf(counts_map_data,coords = c("LONGITUDE","LATITUDE"),crs = 4326,remove = F)


# Calculate bounding box from your data
bbox <- sf::st_bbox(user_data_sf)

# Calculate center of the bounding box
center_lon <- mean(c(bbox["xmin"], bbox["xmax"]))
center_lat <- mean(c(bbox["ymin"], bbox["ymax"]))

# Get width and height
width <- max(abs(bbox["xmax"] - bbox["xmin"]),0.2)
height <- max(abs(bbox["ymax"] - bbox["ymin"]),0.2)

# Determine max side to make it square
half_side <- max(width, height) / 2

# Create invisible square corner points
square_bounds <- data.frame(
  LONGITUDE = c(center_lon - half_side*1.5, center_lon + half_side*1.5),
  LATITUDE = c(center_lat - half_side, center_lat + half_side)
) %>% sf::st_as_sf(coords = c("LONGITUDE","LATITUDE"),crs = 4326,remove = F)

# Add geom_blank() with these points to enforce square aspect ratio
ggplot() +
  ggspatial::annotation_map_tile(type="osm",progress = "none",zoomin=-1) +
  ggspatial::layer_spatial(square_bounds,size = 0,alpha =0) +  # <-- square padding
  {if(recorded_this_year)ggspatial::layer_spatial(user_data_sf %>% filter(year == previous_year), colour = "gray35", size = 5)} +
  {if(recorded_this_year)ggspatial::layer_spatial(user_data_sf %>% filter(year == current_year), colour = "#b31982", size = 5)} +
  {if(!recorded_this_year)ggspatial::layer_spatial(user_data_sf %>% filter(year == previous_year), colour = "#b31982", size = 5)} +
  geom_spatial_label_repel(
    data = counts_map_data %>% filter(year == current_year, n > 1),
    aes(LONGITUDE, LATITUDE, label = label),
    box.padding = 1
  ) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
  
  
```

## Target flowers

In `r if_else(recorded_this_year,current_year,previous_year)`, you `r if_else(recorded_this_year,"have","")` completed FIT Counts on **`r params$user_computed_objects$flower_types_recorded %>% filter(n>0) %>% nrow()`** different target flower types! You can find a guide to identifying the target flowers [here](https://ukpoms.org.uk/sites/default/files/pdf/FIT%20Count%20flower%20guide%20v7.pdf).

```{r}
params$user_computed_objects$flower_types_recorded %>%
  arrange(-n) %>%
  mutate(" "=if_else(n>0,"✅",  " ") )%>%
  mutate(n2 = sapply(n, function(x) paste(rep("✅", x), collapse = ""))) %>%
  mutate(n2 = if_else(nchar(n2)>9,paste0("✅x",n),n2)) %>%
  select(target_flower,n2) %>%
  rename("Target Flower" = "target_flower","Your FIT Counts"="n2") %>%
  kable() 
```

## Insect diversity

In `r focal_year`, you observed an average of `r params$user_data %>% filter(year == focal_year) %>% pull(all_insects_total) %>% median(na.rm=T)` insects per FIT Count . Let's take a look at the types of insects you most frequently observed per FIT Count (totals from all your Counts so far), and see how that compares to other FIT Counters.

```{r, echo=F}
#user's taxon groups proportions
user_diversity <- params$user_data %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
  mutate(year = lubridate::year(as.POSIXct(date_from))) %>%
  filter(year == focal_year) %>%
  select(user_id,sample_id,bumblebees,honeybees,solitary_bees,wasps,hoverflies,other_flies,butterflies_moths,beetles,insects_small,insects_other) %>%
  pivot_longer(c(-user_id,-sample_id)) %>%
  group_by(user_id,name) %>%
  summarise(average_count_per_fit = mean(value,na.rm=T)) %>%
  mutate(you = T)
            

bg_diversity <- params$bg_data %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
  mutate(year = lubridate::year(as.POSIXct(date_from))) %>%
  filter(year == focal_year) %>%
  select(user_id,sample_id,bumblebees,honeybees,solitary_bees,wasps,hoverflies,other_flies,butterflies_moths,beetles,insects_small,insects_other) %>%
  pivot_longer(c(-user_id,-sample_id)) %>%
  group_by(user_id,name) %>%
  summarise(average_count_per_fit = mean(value,na.rm=T)) %>%
  group_by(name) %>%
  summarise(average_count_per_fit = mean(average_count_per_fit,na.rm=T)) %>%
  mutate(you = F)

diversity <- bind_rows(user_diversity,bg_diversity) %>%
  mutate(name = recode(name, 
                      bumblebees = "Bumblebees",
                      honeybees = "Honeybees",
                      solitary_bees = "Solitary Bees",
                      wasps = "Wasps",
                      hoverflies = "Hoverflies",
                      other_flies = "Other Flies",
                      butterflies_moths = "Butterflies and Moths",
                      beetles = "Beetles",
                      insects_small = "Small Insects",
                      insects_other = "Other Insects")) %>%
  mutate(name = factor(name,
                      levels = rev(c("Bumblebees", "Honeybees", "Solitary Bees", "Wasps", 
                                 "Hoverflies", "Other Flies", "Butterflies and Moths",
                                 "Beetles", "Small Insects", "Other Insects"))))



diversity %>%
  ggplot(aes(y = name,x = average_count_per_fit,fill = you))+
  geom_col(position = "dodge") +
  scale_fill_manual(labels = c("Other FIT Counters","You"),values=c("grey","#b31982"))+
  labs(y = "Pollinator group",x = "Average number of insects per FIT Count         ")+
  theme_minimal(base_size = 15)+
  theme(legend.position="top",legend.title = element_blank())

```

## Thank you!

Thank you for sending in your FIT Count results! Please do continue counting when you can, the more results we have the better we are able to monitor how pollinators are doing.

Don't forget: FIT Counts can be done anywhere, including gardens and parks, in warm, dry weather during daylight hours from 1 April to 30 September. You can do surveys using the [FIT Count app](https://ukpoms.org.uk/fit-count-app)

<!--There are different ways to record and generate valuable biodiversity data. For example:

 * Complete FIT Counts in the same place over time to help understand changing flight periods within a season, or trends across years
 * Complete FIT Counts in different places to help understand species distributions
 * Complete FIT Counts for different target flowers to help understand plant-pollinator interactions
 -->

You can also sign up to the PoMS newsletter mailing list [here](https://ukpoms.org.uk/subscribe).



